
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Regression splines &#8212; Applied Statistics</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Applied Statistics</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../docs/course-overview.html">
                    Course overview
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course information
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/course-schedule.html">
   Course schedule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/course-syllabus.html">
   Course syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/course-support.html">
   Course support
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Programming
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="code-overview.html">
   Code overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/programming-toolkit.html">
   Programming toolkit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/programming-environment.html">
   Anaconda environment
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Project
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/project-description.html">
   Project description
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/project-tips-resources.html">
   Tips &amp; resources
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Weekly materials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/weeks-overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week1.html">
   Week 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week2.html">
   Week 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week3.html">
   Week 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week4.html">
   Week 4
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week5.html">
   Week 5
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week6.html">
   Week 6
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week7.html">
   Week 7
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week8.html">
   Week 8
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../weeks/week9.html">
   Bonus material
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/reference.html">
   Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://colab.research.google.com/github/as-ws22/website/blob/main/code/48-splines.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/as-ws22/website"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/as-ws22/website/issues/new?title=Issue%20on%20page%20%2Fcode/48-splines.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/code/48-splines.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import">
     Import
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-label-and-feature">
     Create label and feature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-split">
     Data split
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-exploration">
     Data exploration
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ridge-regression">
   Ridge regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#polynomial-regression">
   Polynomial regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines-scikit-learn">
   Splines (scikit-learn)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spline-transformer">
     Spline transformer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#periodic-splines">
     Periodic splines
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines-statsmodels">
   Splines (statsmodels)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#natural-spline">
     Natural spline
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#models-summary">
   Models summary
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Regression splines</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#import">
     Import
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-label-and-feature">
     Create label and feature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-split">
     Data split
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-exploration">
     Data exploration
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ridge-regression">
   Ridge regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#polynomial-regression">
   Polynomial regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines-scikit-learn">
   Splines (scikit-learn)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spline-transformer">
     Spline transformer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#periodic-splines">
     Periodic splines
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines-statsmodels">
   Splines (statsmodels)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#natural-spline">
     Natural spline
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#models-summary">
   Models summary
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="regression-splines">
<h1>Regression splines<a class="headerlink" href="#regression-splines" title="Permalink to this headline">#</a></h1>
<p><em>The following code tutorial is mainly based on the <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/linear_model/plot_polynomial_interpolation.html#sphx-glr-auto-examples-linear-model-plot-polynomial-interpolation-py">scikit learn documentation</a> about splines provided by Mathieu Blondel, Jake Vanderplas, Christian Lorentzen and Malte Londschien and code from <a class="reference external" href="https://nbviewer.org/github/JWarmenhoven/ISL-python/blob/master/Notebooks/Chapter%207.ipynb">Jordi Warmenhoven</a></em>. To learn more about the spline regression method, review <a class="reference external" href="https://www.statlearning.com/">“An Introduction to Statistical Learning”</a> from <span id="id1">[<a class="reference internal" href="../docs/reference.html#id6" title="Gareth James, Daniela Witten, Trevor Hastie, and Robert Tibshirani. An Introduction to Statistical learning. Springer, 2021. URL: https://www.statlearning.com/.">James <em>et al.</em>, 2021</a>]</span>.</p>
<ul class="simple">
<li><p>Regression splines involve dividing the range of a feature X into K distinct regions (by using so called knots). Within each region, a polynomial function (also called a Basis Spline or B-splines) is fit to the data.</p></li>
<li><p>In the following example, various piecewise polynomials are fit to the data, with one knot at age=50 <span id="id2">[<a class="reference internal" href="../docs/reference.html#id6" title="Gareth James, Daniela Witten, Trevor Hastie, and Robert Tibshirani. An Introduction to Statistical learning. Springer, 2021. URL: https://www.statlearning.com/.">James <em>et al.</em>, 2021</a>]</span>:</p></li>
</ul>
<p><img alt="" src="../_images/splines.png" /></p>
<p>Figures:</p>
<ul class="simple">
<li><p>Top Left: The cubic polynomials are unconstrained.</p></li>
<li><p>Top Right: The cubic polynomials are constrained to be continuous at age=50.</p></li>
<li><p>Bottom Left: The cubic polynomials are constrained to be continuous, and to
have continuous first and second derivatives.</p></li>
<li><p>Bottom Right: A linear spline is shown, which is constrained to be continuous.</p></li>
</ul>
<ul class="simple">
<li><p>The polynomials are ususally constrained so that they join smoothly at the region boundaries, or knots.</p></li>
<li><p>Provided that the interval is divided into enough regions, this can produce an extremely flexibel fit <span id="id3">[<a class="reference internal" href="../docs/reference.html#id6" title="Gareth James, Daniela Witten, Trevor Hastie, and Robert Tibshirani. An Introduction to Statistical learning. Springer, 2021. URL: https://www.statlearning.com/.">James <em>et al.</em>, 2021</a>]</span>:</p></li>
</ul>
<p><img alt="" src="../_images/splines-2.png" /></p>
<p>Figure: A cubic spline and a natural cubic spline, with three knots. The dashed lines denote the knot locations.</p>
<ul class="simple">
<li><p>To understand the advantages of regression splines, we first start with a linear ridge regression model, build a simple polynomial regression and then proceed to splines.</p></li>
</ul>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
np.set_printoptions(suppress=True)
import pandas as pd

from sklearn.model_selection import train_test_split
from sklearn import linear_model
from sklearn.metrics import mean_squared_error

%matplotlib inline
import seaborn as sns 
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Write function to obtain RMSE for training and test data:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>results = []

# create function to obtain model rmse
def model_results(model_name):

    # Training data
    pred_train = reg.predict(X_train)
    rmse_train = round(mean_squared_error(y_train, pred_train, squared=False),4)

    # Test data
    pred_test = reg.predict(X_test)
    rmse_test =round(mean_squared_error(y_test, pred_test, squared=False),4)

    # Save model results
    new_results = {&quot;model&quot;: model_name, &quot;rmse_train&quot;: rmse_train, &quot;rmse_test&quot;: rmse_test}
    results.append(new_results)  
      
    return results;
</pre></div>
</div>
</div>
</div>
</section>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h2>
<section id="import">
<h3>Import<a class="headerlink" href="#import" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df = pd.read_csv(&#39;https://raw.githubusercontent.com/kirenz/datasets/master/wage.csv&#39;)
df.head(3)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>year</th>
      <th>age</th>
      <th>maritl</th>
      <th>race</th>
      <th>education</th>
      <th>region</th>
      <th>jobclass</th>
      <th>health</th>
      <th>health_ins</th>
      <th>logwage</th>
      <th>wage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>231655</td>
      <td>2006</td>
      <td>18</td>
      <td>1. Never Married</td>
      <td>1. White</td>
      <td>1. &lt; HS Grad</td>
      <td>2. Middle Atlantic</td>
      <td>1. Industrial</td>
      <td>1. &lt;=Good</td>
      <td>2. No</td>
      <td>4.318063</td>
      <td>75.043154</td>
    </tr>
    <tr>
      <th>1</th>
      <td>86582</td>
      <td>2004</td>
      <td>24</td>
      <td>1. Never Married</td>
      <td>1. White</td>
      <td>4. College Grad</td>
      <td>2. Middle Atlantic</td>
      <td>2. Information</td>
      <td>2. &gt;=Very Good</td>
      <td>2. No</td>
      <td>4.255273</td>
      <td>70.476020</td>
    </tr>
    <tr>
      <th>2</th>
      <td>161300</td>
      <td>2003</td>
      <td>45</td>
      <td>2. Married</td>
      <td>1. White</td>
      <td>3. Some College</td>
      <td>2. Middle Atlantic</td>
      <td>1. Industrial</td>
      <td>1. &lt;=Good</td>
      <td>1. Yes</td>
      <td>4.875061</td>
      <td>130.982177</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="create-label-and-feature">
<h3>Create label and feature<a class="headerlink" href="#create-label-and-feature" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>We only use the feature age to predict wage (because we only use one predictor, we don’t perform data standardization)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X = df[[&#39;age&#39;]]
y = df[[&#39;wage&#39;]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-split">
<h3>Data split<a class="headerlink" href="#data-split" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Dividing data into train and test datasets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state = 1)
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-exploration">
<h3>Data exploration<a class="headerlink" href="#data-exploration" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Visualize the relationship between age and wage:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> # seaborn settings
custom_params = {&quot;axes.spines.right&quot;: False, &quot;axes.spines.top&quot;: False}
sns.set_theme(style=&quot;ticks&quot;, rc=custom_params)

# plot
sns.scatterplot(x=X_train[&#39;age&#39;], y=y_train[&#39;wage&#39;], alpha=0.4);
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48-splines_22_0.png" src="../_images/48-splines_22_0.png" />
</div>
</div>
</section>
</section>
<section id="ridge-regression">
<h2>Ridge regression<a class="headerlink" href="#ridge-regression" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>First, we obtain the optimal alpha parameter with cross validation</p></li>
<li><p>We try different values for alpha:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>alphas=np.logspace(-6, 6, 13)
alphas
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([      0.000001,       0.00001 ,       0.0001  ,       0.001   ,
             0.01    ,       0.1     ,       1.      ,      10.      ,
           100.      ,    1000.      ,   10000.      ,  100000.      ,
       1000000.      ])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Fit model</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reg = linear_model.RidgeCV(alphas=alphas)
reg.fit(X_train,y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RidgeCV(alphas=array([      0.000001,       0.00001 ,       0.0001  ,       0.001   ,
             0.01    ,       0.1     ,       1.      ,      10.      ,
           100.      ,    1000.      ,   10000.      ,  100000.      ,
       1000000.      ]))
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Show best alpha</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reg.alpha_
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000.0
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Show coefficients</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(reg.coef_)
print(reg.intercept_)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0.71854335]]
[80.69608773]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_results(model_name=&quot;Ridge&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;model&#39;: &#39;Ridge&#39;, &#39;rmse_train&#39;: 40.7053, &#39;rmse_test&#39;: 41.4135}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sns.regplot(x=X_train[&#39;age&#39;], 
            y=y_train[&#39;wage&#39;], 
            ci=None, 
            line_kws={&quot;color&quot;: &quot;orange&quot;});
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48-splines_33_0.png" src="../_images/48-splines_33_0.png" />
</div>
</div>
</section>
<section id="polynomial-regression">
<h2>Polynomial regression<a class="headerlink" href="#polynomial-regression" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Next, we use a pipeline to add non-linear features to a ridge regression model.</p></li>
<li><p>We use <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.make_pipeline.html"><code class="docutils literal notranslate"><span class="pre">make_pipeline</span></code></a> which is a shorthand for the Pipeline constructor</p>
<ul>
<li><p>It does not require, and does not permit, naming the estimators.</p></li>
<li><p>Instead, their names will be set to the lowercase of their types automatically:</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.preprocessing import PolynomialFeatures
from sklearn.pipeline import make_pipeline

# use polynomial features with degree 3
reg = make_pipeline(
            PolynomialFeatures(degree=3), 
            linear_model.RidgeCV(alphas=alphas)
            )

reg.fit(X_train, y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;polynomialfeatures&#39;, PolynomialFeatures(degree=3)),
                (&#39;ridgecv&#39;,
                 RidgeCV(alphas=array([      0.000001,       0.00001 ,       0.0001  ,       0.001   ,
             0.01    ,       0.1     ,       1.      ,      10.      ,
           100.      ,    1000.      ,   10000.      ,  100000.      ,
       1000000.      ])))])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_results(model_name=&quot;Polynomial Reg&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;model&#39;: &#39;Ridge&#39;, &#39;rmse_train&#39;: 40.7053, &#39;rmse_test&#39;: 41.4135},
 {&#39;model&#39;: &#39;Polynomial Reg&#39;, &#39;rmse_train&#39;: 39.7717, &#39;rmse_test&#39;: 40.2513}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># plot
sns.regplot(x=X_train[&#39;age&#39;], 
            y=y_train[&#39;wage&#39;], 
            ci=None, 
            order=3, 
            line_kws={&quot;color&quot;: &quot;orange&quot;});
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48-splines_37_0.png" src="../_images/48-splines_37_0.png" />
</div>
</div>
</section>
<section id="splines-scikit-learn">
<h2>Splines (scikit-learn)<a class="headerlink" href="#splines-scikit-learn" title="Permalink to this headline">#</a></h2>
<p><em>Note that spline transformers are a new feature in <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/release_highlights/plot_release_highlights_1_0_0.html">scikit learn 1.0</a>. Therefore, make sure to use the latest version of scikit learn. Use <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">list</span> <span class="pre">scikit-learn</span></code> to see which scikit-learn version is installed. If you use Anaconda, you can update all packages using <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">update</span> <span class="pre">--all</span></code></em></p>
<section id="spline-transformer">
<h3>Spline transformer<a class="headerlink" href="#spline-transformer" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>The following function places the knots in a uniform (this is the default) or quantile fashion.</p></li>
<li><p>We only have to specify the desired number of knots, and then have <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.SplineTransformer.html">SplineTransformer</a> automatically place the corresponding number of knots.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.preprocessing import SplineTransformer

# use a spline wit 4 knots and 3 degrees 
# we combine the spline with a ridge regressions
reg = make_pipeline(
                    SplineTransformer(n_knots=4, degree=3), 
                    linear_model.RidgeCV(alphas=alphas)
                    )
reg.fit(X_train, y_train)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pipeline(steps=[(&#39;splinetransformer&#39;, SplineTransformer(n_knots=4)),
                (&#39;ridgecv&#39;,
                 RidgeCV(alphas=array([      0.000001,       0.00001 ,       0.0001  ,       0.001   ,
             0.01    ,       0.1     ,       1.      ,      10.      ,
           100.      ,    1000.      ,   10000.      ,  100000.      ,
       1000000.      ])))])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_results(model_name = &quot;Cubic Spline&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;model&#39;: &#39;Ridge&#39;, &#39;rmse_train&#39;: 40.7053, &#39;rmse_test&#39;: 41.4135},
 {&#39;model&#39;: &#39;Polynomial Reg&#39;, &#39;rmse_train&#39;: 39.7717, &#39;rmse_test&#39;: 40.2513},
 {&#39;model&#39;: &#39;Cubic Spline&#39;, &#39;rmse_train&#39;: 39.7456, &#39;rmse_test&#39;: 40.2444}]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Obtain knots to show them in the following plot (there are degree number of additional knots each to the left and to the right of the fitted interval. These are there for technical reasons, so we refrain from showing them)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>splt = SplineTransformer(n_knots=4, degree=3)
splt.fit(X_train)
knots = splt.bsplines_[0].t

knots[3:-3]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([18.        , 38.66666667, 59.33333333, 80.        ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import numpy as np
import matplotlib.pyplot as plt

# Create observations
x_new = np.linspace(X_test.min(),X_test.max(), 100)
# Make some predictions
pred = reg.predict(x_new)

# plot
sns.scatterplot(x=X_train[&#39;age&#39;], y=y_train[&#39;wage&#39;])

plt.plot(x_new, pred, label=&#39;Cubic spline with 4 knots and degree=3&#39;, color=&#39;orange&#39;)
plt.vlines(knots[3:-3], ymin=0, ymax=300, linestyles=&quot;dashed&quot;)
plt.legend();
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/jankirenz/opt/anaconda3/lib/python3.9/site-packages/sklearn/base.py:450: UserWarning: X does not have valid feature names, but SplineTransformer was fitted with feature names
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/48-splines_43_1.png" src="../_images/48-splines_43_1.png" />
</div>
</div>
</section>
<section id="periodic-splines">
<h3>Periodic splines<a class="headerlink" href="#periodic-splines" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>In some settings, e.g. in time series data with seasonal effects, we expect a periodic continuation of the underlying signal.</p></li>
<li><p>Such effects can be modelled using periodic splines, which have equal function value and equal derivatives at the first and last knot.</p></li>
<li><p>Review this notebook to learn more about periodic splines in scikit learn: <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/linear_model/plot_polynomial_interpolation.html#periodic-splines">periodic splines</a></p></li>
</ul>
</section>
</section>
<section id="splines-statsmodels">
<h2>Splines (statsmodels)<a class="headerlink" href="#splines-statsmodels" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>In statsmodels, we can use pandas dataframes so let’s join our label and feature:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df_train = y_train.join(X_train)
df_test = y_test.join(X_test)

df_train
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>wage</th>
      <th>age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1045</th>
      <td>127.115744</td>
      <td>45</td>
    </tr>
    <tr>
      <th>2717</th>
      <td>118.884359</td>
      <td>51</td>
    </tr>
    <tr>
      <th>2835</th>
      <td>104.921507</td>
      <td>32</td>
    </tr>
    <tr>
      <th>2913</th>
      <td>87.981033</td>
      <td>58</td>
    </tr>
    <tr>
      <th>959</th>
      <td>61.052421</td>
      <td>50</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2763</th>
      <td>73.775743</td>
      <td>44</td>
    </tr>
    <tr>
      <th>905</th>
      <td>104.921507</td>
      <td>49</td>
    </tr>
    <tr>
      <th>1096</th>
      <td>148.413159</td>
      <td>61</td>
    </tr>
    <tr>
      <th>235</th>
      <td>81.283253</td>
      <td>34</td>
    </tr>
    <tr>
      <th>1061</th>
      <td>109.833986</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
<p>2100 rows × 2 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Instead of providing the number of knots, in statsmodels, we have to specify the degrees of freedom (df).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">df</span></code> defines how many parameters we have to estimate.</p></li>
<li><p>They have a specific relationship with the number of knots and the degree, which depends on the type of spline (see <a class="reference external" href="https://stats.stackexchange.com/a/517479">Stackoverflow</a>):</p></li>
<li><p>In the case of <strong>B-splines</strong>:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(df=𝑘+degree\)</span> if you specify the knots or</p></li>
<li><p><span class="math notranslate nohighlight">\(𝑘=df−degree\)</span> if you specify the degrees of freedom and the degree.</p></li>
</ul>
</li>
</ul>
<p>As an example:</p>
<ul class="simple">
<li><p>A cubic spline (degree=3) with 4 knots (K=4) will have <span class="math notranslate nohighlight">\(df=4+3=7\)</span> degrees of freedom. If we use an intercept, we need to add an additional degree of freedom.</p></li>
<li><p>A cubic spline (degree=3) with 5 degrees of freedom (df=5) will have <span class="math notranslate nohighlight">\(𝑘=5−3=2\)</span> knots (assuming the spline has no intercept).</p></li>
<li><p>In our case, we want to fit a cubic spline (degree=3) with an intercept and three knots (K=3). This equals <span class="math notranslate nohighlight">\(df=3+3+1=7\)</span> for our feature. This means that these degrees of freedom are used up by an intercept, plus six basis functions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import statsmodels.api as sm
from statsmodels.gam.api import GLMGam, BSplines

bs = BSplines(X_train[[&#39;age&#39;]], df=7, degree=3)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/jankirenz/opt/anaconda3/lib/python3.9/site-packages/statsmodels/compat/pandas.py:61: FutureWarning: pandas.Int64Index is deprecated and will be removed from pandas in a future version. Use pandas.Index with the appropriate dtype instead.
  from pandas import Int64Index as NumericIndex
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We fit a Generalized Additive Model (GAM). To learn more about GAMs, visit <span class="xref myst"></span>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reg = GLMGam.from_formula(&#39;wage ~ age&#39;, data=df_train, smoother=bs).fit()
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Take a look at the results</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(reg.summary())
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:                   wage   No. Observations:                 2100
Model:                         GLMGam   Df Residuals:                     2093
Model Family:                Gaussian   Df Model:                            6
Link Function:               identity   Scale:                          1582.9
Method:                         PIRLS   Log-Likelihood:                -10712.
Date:                Sat, 23 Apr 2022   Deviance:                   3.3129e+06
Time:                        13:19:11   Pearson chi2:                 3.31e+06
No. Iterations:                     3   Pseudo R-squ. (CS):            0.09038
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     38.3686     11.185      3.431      0.001      16.447      60.290
age            1.1034      0.182      6.074      0.000       0.747       1.459
age_s0        17.0585     13.393      1.274      0.203      -9.192      43.309
age_s1        38.4351      6.901      5.569      0.000      24.909      51.961
age_s2        34.9717      6.524      5.361      0.000      22.186      47.758
age_s3        13.6359      7.383      1.847      0.065      -0.835      28.107
age_s4        12.8306     14.500      0.885      0.376     -15.588      41.250
age_s5       -53.3174     12.324     -4.326      0.000     -77.472     -29.163
==============================================================================
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Obtain RMSE for training and test data:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_name = &quot;Spline statsmodels&quot;

# Training data
df_train[&#39;pred_train&#39;] = reg.predict()
rmse_train = round(mean_squared_error(df_train[&#39;wage&#39;], df_train[&#39;pred_train&#39;], squared=False),4)

# Test data
df_test[&#39;pred_test&#39;] = reg.predict(df_test, exog_smooth= df_test[&#39;age&#39;])
rmse_test = round(mean_squared_error(df_test[&#39;wage&#39;], df_test[&#39;pred_test&#39;], squared=False),4)

# Save model results
new_results = {&quot;model&quot;: model_name, &quot;rmse_train&quot;: rmse_train, &quot;rmse_test&quot;: rmse_test}
results.append(new_results)  

results
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;model&#39;: &#39;Ridge&#39;, &#39;rmse_train&#39;: 40.7053, &#39;rmse_test&#39;: 41.4135},
 {&#39;model&#39;: &#39;Polynomial Reg&#39;, &#39;rmse_train&#39;: 39.7717, &#39;rmse_test&#39;: 40.2513},
 {&#39;model&#39;: &#39;Cubic Spline&#39;, &#39;rmse_train&#39;: 39.7456, &#39;rmse_test&#39;: 40.2444},
 {&#39;model&#39;: &#39;Spline statsmodels&#39;, &#39;rmse_train&#39;: 39.7188, &#39;rmse_test&#39;: 40.2194}]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We plot the spline with the Statsmodel’s function <a class="reference external" href="https://www.statsmodels.org/devel/generated/statsmodels.gam.generalized_additive_model.GLMGamResults.plot_partial.html">.plot_partial</a>:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
reg.plot_partial(0, cpr=True, plot_se=False)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48-splines_58_0.png" src="../_images/48-splines_58_0.png" />
<img alt="../_images/48-splines_58_1.png" src="../_images/48-splines_58_1.png" />
</div>
</div>
<section id="natural-spline">
<h3>Natural spline<a class="headerlink" href="#natural-spline" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Finally, we fit a natural spline with <a class="reference external" href="https://patsy.readthedocs.io/en/latest/">patsy</a> and statsmodels.</p></li>
<li><p>In patsy one can specify the number of degrees of freedom directly (actual number of columns of the resulting design matrix)</p></li>
<li><p>In the case of natural splines: <span class="math notranslate nohighlight">\(df=𝑘−1\)</span> if you specify the knots or <span class="math notranslate nohighlight">\(𝑘=df+1\)</span> if you specify the degrees of freedom.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from patsy import dmatrix

bs = dmatrix(&quot;cr(train, df = 3)&quot;, {&quot;train&quot;: X_train}, return_type=&#39;dataframe&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We use statsmodel’s “Generalized linear models” (review this <a class="reference external" href="https://kirenz.github.io/regression/docs/gam.html">tutorial</a> to learn more about GAMs)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>reg = sm.GLM(y_train, bs).fit()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model_name = &#39;Natural Spline&#39;

# Training data
pred_train = reg.predict(dmatrix(&quot;cr(train, df=3)&quot;, {&quot;train&quot;: X_train}, return_type=&#39;dataframe&#39;))
rmse_train = round(mean_squared_error(y_train, pred_train, squared=False),4)

# Test data
pred_test = reg.predict(dmatrix(&quot;cr(test, df=3)&quot;, {&quot;test&quot;: X_test}, return_type=&#39;dataframe&#39;))
rmse_test = round(mean_squared_error(y_test, pred_test, squared=False),4)

# Save model results
new_results = {&quot;model&quot;: model_name, &quot;rmse_train&quot;: rmse_train, &quot;rmse_test&quot;: rmse_test}
results.append(new_results)  

results
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;model&#39;: &#39;Ridge&#39;, &#39;rmse_train&#39;: 40.7053, &#39;rmse_test&#39;: 41.4135},
 {&#39;model&#39;: &#39;Polynomial Reg&#39;, &#39;rmse_train&#39;: 39.7717, &#39;rmse_test&#39;: 40.2513},
 {&#39;model&#39;: &#39;Cubic Spline&#39;, &#39;rmse_train&#39;: 39.7456, &#39;rmse_test&#39;: 40.2444},
 {&#39;model&#39;: &#39;Spline statsmodels&#39;, &#39;rmse_train&#39;: 39.7188, &#39;rmse_test&#39;: 40.2194},
 {&#39;model&#39;: &#39;Natural Spline&#39;, &#39;rmse_train&#39;: 39.8826, &#39;rmse_test&#39;: 40.3252}]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plot model</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>xp = np.linspace(X_test.min(),X_test.max(), 100)

# Make predictions
pred = reg.predict(dmatrix(&quot;cr(xp, df=3)&quot;, {&quot;xp&quot;: xp}, return_type=&#39;dataframe&#39;))

# plot
sns.scatterplot(x=X_train[&#39;age&#39;], y=y_train[&#39;wage&#39;])
plt.plot(xp, pred, color=&#39;orange&#39;, label=&#39;Natural spline with df=3&#39;)
plt.legend();
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48-splines_65_0.png" src="../_images/48-splines_65_0.png" />
</div>
</div>
</section>
</section>
<section id="models-summary">
<h2>Models summary<a class="headerlink" href="#models-summary" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Create a dataframe from model results</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>df_results = pd.DataFrame(results) 

df_results.sort_values(by=[&#39;rmse_test&#39;])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model</th>
      <th>rmse_train</th>
      <th>rmse_test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>Spline statsmodels</td>
      <td>39.7188</td>
      <td>40.2194</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Cubic Spline</td>
      <td>39.7456</td>
      <td>40.2444</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Polynomial Reg</td>
      <td>39.7717</td>
      <td>40.2513</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Natural Spline</td>
      <td>39.8826</td>
      <td>40.3252</td>
    </tr>
    <tr>
      <th>0</th>
      <td>Ridge</td>
      <td>40.7053</td>
      <td>41.4135</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./code"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Jan Kirenz<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>